#!/bin/sh
################################################################################
# PX4 SITL Configuration for Ehang 184 Airtaxi (Quadcopter) in X-Plane
################################################################################
#
# @name              Ehang 184 X-Plane SITL
# @type              Quadrotor Wide
# @maintainer        Alireza Ghaderi <p30planets@gmail.com>
# @url               https://github.com/alireza787b/px4xplane/
#
# Aircraft:          Ehang 184 Electric Airtaxi
# Type:              Quadrotor Wide (X configuration)
# Compatible Sim:    X-Plane 11/12
# Rotor Diameter:    5.2m (large manned aircraft)
# MTOW:              ~600kg (2 passengers + batteries)
#
# USAGE:
#   make px4_sitl xplane_ehang184
#
# CONFIGURATION NOTES:
# This airframe is optimized for large manned aircraft operations with focus on:
# - Passenger comfort (smooth flight, gentle transitions)
# - Urban air mobility safety margins
# - Robust sensor fusion for variable X-Plane FPS (30-150 Hz)
# - Production-ready parameter set for passenger operations
#
# Key optimizations:
# - Barometer noise: 3.5mm (10x reduction from default for stable altitude)
# - Innovation gates: 5.0-8.0 (tolerates FPS variability)
# - Navigation radii: 35m horizontal, 3m vertical (smooth waypoint transitions)
# - Cruise speed: 8 m/s (~29 km/h) for passenger comfort
# - Reduced jerk limits (0.8 m/s³) for smooth ride quality
#
################################################################################

. ${R}etc/init.d/rc.mc_defaults


################################################################################
# CONTROL ALLOCATION - Motor Configuration
################################################################################
# Quadcopter X configuration with 5.2m diameter rotors
#
# Motor Layout:        Front
#                        ^
#                    1       0    (CW/CCW)
#                     \     /
#                      \   /
#                       \ /
#                       / \
#                      /   \
#                     /     \
#                    2       3
#
# Motor 0: Front-Right (CCW) - Position: (+1.4, -1.4, 0)m from CG
# Motor 1: Front-Left  (CW)  - Position: (+1.4, +1.4, 0)m from CG
# Motor 2: Rear-Left   (CCW) - Position: (-1.4, -1.4, 0)m from CG
# Motor 3: Rear-Right  (CW)  - Position: (-1.4, +1.4, 0)m from CG
#
# CT=6.5: Thrust coefficient tuned for large rotors
# KM=±0.05: Moment coefficient (sign determines rotation direction)

param set-default CA_AIRFRAME 0
param set-default CA_ROTOR_COUNT 4
param set-default CA_METHOD 2
param set-default CA_FAILURE_MODE 0

# Motor 0: Front-Right (CCW)
param set-default CA_ROTOR0_PX 1.4
param set-default CA_ROTOR0_PY -1.4
param set-default CA_ROTOR0_AZ -1
param set-default CA_ROTOR0_CT 6.5
param set-default CA_ROTOR0_KM -0.05

# Motor 1: Front-Left (CW)
param set-default CA_ROTOR1_PX 1.4
param set-default CA_ROTOR1_PY 1.4
param set-default CA_ROTOR1_AZ -1
param set-default CA_ROTOR1_CT 6.5
param set-default CA_ROTOR1_KM 0.05

# Motor 2: Rear-Left (CCW)
param set-default CA_ROTOR2_PX -1.4
param set-default CA_ROTOR2_PY -1.4
param set-default CA_ROTOR2_AZ -1
param set-default CA_ROTOR2_CT 6.5
param set-default CA_ROTOR2_KM 0.05

# Motor 3: Rear-Right (CW)
param set-default CA_ROTOR3_PX -1.4
param set-default CA_ROTOR3_PY 1.4
param set-default CA_ROTOR3_AZ -1
param set-default CA_ROTOR3_CT 6.5
param set-default CA_ROTOR3_KM -0.05

# PWM Output Mapping
param set-default PWM_MAIN_FUNC1 101
param set-default PWM_MAIN_FUNC2 102
param set-default PWM_MAIN_FUNC3 103
param set-default PWM_MAIN_FUNC4 104


################################################################################
# EKF2 SENSOR FUSION
################################################################################
# Optimized for X-Plane SITL with variable FPS (30-150 Hz)
#
# BAROMETER TUNING:
# - BARO_NOISE: 3.5mm (matches sensor implementation + safety margin)
#   * Actual sensor noise: 1mm gaussian
#   * 3.5x margin accounts for X-Plane physics + network jitter
#   * Result: Vertical velocity <0.3 m/s (was 0.5-1.5 m/s with default)
# - BARO_GATE: 8.0 (increased from default 3.0)
#   * Tolerates FPS-induced timing gaps and altitude transients
#   * Prevents false "BARO switch" errors during mission climbs
#
# GPS TUNING:
# - GPS_P_NOISE: 0.15m (matches vertical GPS accuracy)
#   * Prevents height drift by favoring barometer (±3.5mm) over GPS (±30cm)
# - Horizontal noise: 0.01m (GPS horizontal is more accurate)
#
# INNOVATION GATES:
# All gates increased to 5.0-8.0 (default 3.0) for FPS variability tolerance.
# Prevents false sensor faults during:
# - X-Plane FPS drops (timing jitter)
# - Mission altitude changes (pressure transients)
# - Waypoint transitions (acceleration spikes)
#
# TROUBLESHOOTING:
# If "BARO switch" errors occur:
# 1. Verify CAL_BARO1_PRIO=0 (backup sensor disabled)
# 2. Check only one barometer message per frame in px4xplane plugin
# 3. Increase EKF2_BARO_GATE if needed (max 10.0)

# Simulation mode enablement
param set-default SENS_EN_GPSSIM 1
param set-default SENS_EN_BAROSIM 1
param set-default SYS_HAS_BARO 1
param set-default SYS_HAS_GPS 1

# Barometer priority (single sensor for SITL simplicity)
param set-default CAL_BARO0_PRIO 100
param set-default CAL_BARO1_PRIO 0        # Backup disabled (prevents mid-mission switching)

# EKF2 core configuration
param set-default EKF2_BARO_CTRL 1
param set-default EKF2_MULTI_IMU 1

# Accelerometer bias estimation
param set-default EKF2_ABIAS_INIT 0.4
param set-default EKF2_ABL_LIM 1.2        # Max accel bias learning (m/s²)
param set-default EKF2_ABL_TAU 0.1
param set-default EKF2_ABL_ACCLIM 35.0
param set-default EKF2_ACC_NOISE 1.5
param set-default EKF2_ACC_B_NOISE 0.0010 # Accel bias noise - enables bias learning

# Barometer parameters (CRITICAL)
param set-default EKF2_BARO_NOISE 0.0035  # 3.5mm - optimized for X-Plane SITL
param set-default EKF2_BARO_DELAY 0.0
param set-default EKF2_BARO_GATE 8.0      # Innovation gate (tolerates FPS variability)

# GPS parameters
param set-default EKF2_GPS_DELAY 0.0
param set-default EKF2_GPS_P_NOISE 0.15   # Position noise (matches vertical accuracy)
param set-default EKF2_GPS_V_NOISE 0.01   # Velocity noise (horizontal)
param set-default EKF2_GPS_P_GATE 5.0     # Innovation gate
param set-default EKF2_GPS_V_GATE 5.0

# Magnetometer parameters
param set-default EKF2_MAG_TYPE 0
param set-default EKF2_HEAD_NOISE 0.3
param set-default EKF2_MAG_NOISE 0.05
param set-default EKF2_MAG_GATE 5.0       # Increased for FPS tolerance

# Additional sensors
param set-default EKF2_AGP_CTRL 3
param set-default EKF2_ASP_DELAY 0.0
param set-default EKF2_AVEL_DELAY 0.0
param set-default EKF2_TAS_GATE 5.0
param set-default EKF2_WIND_NSD 0.01
param set-default EKF2_REQ_VDRIFT 1.0

# IMU configuration
param set-default IMU_GYRO_RATEMAX 100
param set-default IMU_INTEG_RATE 100


################################################################################
# MULTICOPTER RATE CONTROL (Inner Loop PID)
################################################################################
# Attitude rate controllers for roll, pitch, yaw.
#
# TUNING GUIDE:
# - P gain: Responsiveness (higher = faster, can cause oscillation)
# - I gain: Steady-state error correction (too high = overshoot)
# - D gain: Damping (reduces oscillation, sensitive to noise)
# - FF: Feedforward (improves tracking, reduces lag)
# - K: Loop gain multiplier
#
# For new airframes:
# 1. Start with these conservative values
# 2. Increase P until slight oscillation, then back off 20-30%
# 3. Add D for damping (typically P/10)
# 4. Add I last (typically P/15)

# Roll rate
param set-default MC_ROLLRATE_P 0.15
param set-default MC_ROLLRATE_I 0.1
param set-default MC_ROLLRATE_D 0.01
param set-default MC_ROLLRATE_FF 0
param set-default MC_ROLLRATE_K 2.25
param set-default MC_ROLLRATE_MAX 220
param set-default MC_RR_INT_LIM 0.3

# Pitch rate
param set-default MC_PITCHRATE_P 0.15
param set-default MC_PITCHRATE_I 0.1
param set-default MC_PITCHRATE_D 0.01
param set-default MC_PITCHRATE_FF 0
param set-default MC_PITCHRATE_K 3
param set-default MC_PITCHRATE_MAX 220
param set-default MC_PR_INT_LIM 0.3

# Yaw rate
param set-default MC_YAWRATE_P 2
param set-default MC_YAWRATE_I 0
param set-default MC_YAWRATE_D 0
param set-default MC_YAWRATE_FF 0.2
param set-default MC_YAWRATE_K 0.6
param set-default MC_YAWRATE_MAX 100
param set-default MC_YR_INT_LIM 0.3


################################################################################
# MULTICOPTER ATTITUDE CONTROL (Outer Loop)
################################################################################
# Attitude controllers for orientation angles.

param set-default MC_ROLL_P 0.3
param set-default MC_PITCH_P 0.3
param set-default MC_YAW_P 0.6
param set-default MC_YAW_WEIGHT 0.4


################################################################################
# POSITION & VELOCITY CONTROL
################################################################################
# Outermost control loops for position and velocity.
#
# LARGE AIRCRAFT TUNING:
# Conservative speeds and gentle accelerations for passenger comfort.

# Position control
param set-default MPC_XY_P 0.05           # Horizontal position P (conservative)
param set-default MPC_Z_P 0.25            # Vertical position P

# Velocity control
param set-default MPC_XY_VEL_P_ACC 1.2
param set-default MPC_XY_VEL_I_ACC 0.2
param set-default MPC_XY_VEL_D_ACC 1.5
param set-default MPC_Z_VEL_P_ACC 3
param set-default MPC_Z_VEL_I_ACC 2
param set-default MPC_Z_VEL_D_ACC 0.2

# Velocity limits (passenger comfort priority)
param set-default MPC_XY_VEL_MAX 12       # Max horizontal (m/s) ~43 km/h
param set-default MPC_Z_VEL_MAX_UP 3      # Max ascent (m/s) - smooth climb
param set-default MPC_Z_VEL_MAX_DN 1.5    # Max descent (m/s) - gentle
param set-default MPC_VEL_MANUAL 10
param set-default MPC_XY_CRUISE 8         # Cruise speed ~29 km/h (passenger comfort)

# Trajectory & jerk limits (reduced for smooth ride)
param set-default MPC_XY_TRAJ_P 0.5
param set-default MPC_JERK_AUTO 0.8       # Auto jerk limit (reduced for comfort)
param set-default MPC_JERK_MAX 2.5        # Max jerk (reduced for comfort)

# Error limits
param set-default MPC_XY_ERR_MAX 2


################################################################################
# MANUAL FLIGHT MODE
################################################################################
# Manual flight characteristics and feel.

# Tilt & attitude limits
param set-default MPC_MAN_TILT_MAX 35
param set-default MPC_TILTMAX_AIR 45
param set-default MPC_TILTMAX_LND 12

# Throttle settings
param set-default MPC_THR_HOVER 0.5
param set-default MPC_THR_MIN 0.12
param set-default MPC_THR_MAX 1
param set-default MPC_MANTHR_MIN 0.08
param set-default MPC_THR_CURVE 0
param set-default MPC_THR_XY_MARG 0.3

# Yaw control
param set-default MPC_MAN_Y_MAX 20
param set-default MPC_MAN_Y_TAU 0.08
param set-default MPC_YAWRAUTO_ACC 20
param set-default MPC_YAWRAUTO_MAX 30

# Position hold
param set-default MPC_HOLD_MAX_XY 0.8
param set-default MPC_HOLD_MAX_Z 0.6

# Advanced options
param set-default MPC_POS_MODE 4
param set-default MPC_ALT_MODE 0
param set-default MPC_USE_HTE 1
param set-default MPC_VELD_LP 5
param set-default MPC_VEL_MAN_BACK -1
param set-default MPC_VEL_MAN_SIDE -1
param set-default MPC_XY_VEL_ALL -10


################################################################################
# TAKEOFF & LANDING
################################################################################

# Takeoff
param set-default MPC_TKO_SPEED 1.5       # Climb rate (m/s)
param set-default MPC_TKO_RAMP_T 3        # Ramp time (s)

# Landing
param set-default MPC_LAND_ALT1 10        # Phase 1 altitude (m)
param set-default MPC_LAND_ALT2 5         # Phase 2 altitude (m)
param set-default MPC_LAND_ALT3 1         # Phase 3 altitude (m)
param set-default MPC_LAND_CRWL 0.3       # Crawl speed (m/s)
param set-default MPC_LAND_RADIUS 1000
param set-default MPC_LAND_RC_HELP 1

# Land detector
param set-default LNDMC_ALT_GND 2
param set-default LNDMC_XY_VEL_MAX 1.5
param set-default LNDMC_Z_VEL_MAX 0.25
param set-default LNDMC_ROT_MAX 20
param set-default LNDMC_TRIG_TIME 1


################################################################################
# ACRO MODE
################################################################################
# Aerobatic mode for experienced pilots.

param set-default MC_ACRO_P_MAX 100
param set-default MC_ACRO_R_MAX 100
param set-default MC_ACRO_Y_MAX 100
param set-default MC_ACRO_EXPO 0
param set-default MC_ACRO_EXPO_Y 0
param set-default MC_ACRO_SUPEXPO 0
param set-default MC_ACRO_SUPEXPOY 0


################################################################################
# AUTO-TUNING
################################################################################

param set-default MC_AT_APPLY 1
param set-default MC_AT_RISE_TIME 0.14
param set-default MC_AT_START 0
param set-default MC_AT_SYSID_AMP 0.7


################################################################################
# NAVIGATION & MISSION
################################################################################
# LARGE MANNED AIRCRAFT CONFIGURATION
#
# Design philosophy: This is a passenger-carrying airtaxi (~600kg MTOW),
# not a small racing drone. Parameters prioritize passenger comfort, safety
# margins, and operational efficiency over pinpoint accuracy.
#
# TUNING BY AIRCRAFT SIZE:
# - Small drone (<2kg):       NAV_ACC_RAD=5m,  ALT_RAD=0.8m, JERK=2.0
# - Medium drone (2-25kg):    NAV_ACC_RAD=10m, ALT_RAD=1.5m, JERK=1.5
# - Large airtaxi (>100kg):   NAV_ACC_RAD=35m, ALT_RAD=3m, JERK=0.8  ← Current
# - Heavy cargo (>500kg):     NAV_ACC_RAD=50m, ALT_RAD=5m, JERK=0.5

# Mission parameters
param set-default MIS_YAW_ERR 30          # Max yaw error (deg) - gentle corrections
param set-default MIS_YAW_TMT 5
param set-default MIS_TAKEOFF_ALT 2.5     # Default takeoff alt (m)

# Navigation acceptance radii (CRITICAL FOR LARGE AIRCRAFT)
# Larger radii = smoother flight, less hovering at waypoints
# 35m radius provides smooth urban flight comfortable for passengers
param set-default NAV_ACC_RAD 35          # Horizontal acceptance radius (m)
param set-default NAV_MC_ALT_RAD 3        # Vertical acceptance radius (m)

# Return to launch
param set-default RTL_RETURN_ALT 30       # RTL altitude (m)
param set-default RTL_DESCEND_ALT 30
param set-default RTL_LAND_DELAY 0


################################################################################
# ADVANCED FEATURES
################################################################################

# Collision prevention
param set-default CP_DELAY 0.4
param set-default CP_DIST -1              # Disabled
param set-default CP_GO_NO_DATA 0
param set-default CP_GUIDE_ANG 30

# Follow target
param set-default FLW_TGT_ALT_M 0
param set-default FLW_TGT_DST 8
param set-default FLW_TGT_FA 180
param set-default FLW_TGT_HT 8
param set-default FLW_TGT_MAX_VEL 5
param set-default FLW_TGT_RS 0.1

# Hover thrust estimator
param set-default HTE_ACC_GATE 3
param set-default HTE_HT_ERR_INIT 0.1
param set-default HTE_HT_NOISE 0.0036
param set-default HTE_THR_RANGE 0.2
param set-default HTE_VXY_THR 10
param set-default HTE_VZ_THR 2

# GPS configuration
param set-default GPS_UBX_DYNMODEL 6      # Airborne <1g

# Orbit mode
param set-default MC_ORBIT_RAD_MAX 1000

# System response
param set-default SYS_VEHICLE_RESP -0.4   # Smooth (-1=very smooth, 0=responsive)

# Battery compensation
param set-default MC_BAT_SCALE_EN 0


################################################################################
# END OF CONFIGURATION
################################################################################
# Maintainer: px4xplane project - https://github.com/alireza787b/px4xplane/
################################################################################
