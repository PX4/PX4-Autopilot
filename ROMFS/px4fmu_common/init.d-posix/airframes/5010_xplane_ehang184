#!/bin/sh
################################################################################
# PX4 SITL Configuration for EHang 184 Air Taxi (Quadcopter) in X-Plane
################################################################################
#
# @name              EHang 184 X-Plane SITL
# @type              Quadrotor Wide
# @maintainer        alireza787b <p30planets@gmail.com>
# @url               https://github.com/alireza787b/px4xplane/
#
# Airframe:          EHang 184 Electric Air Taxi
# Type:              Quadrotor Wide (X configuration)
# Configuration:     4 Large Rotors (5.2m diameter)
# Compatible Sim:    X-Plane 11/12
# Date:              December 2025
#
# AIRCRAFT SPECIFICATIONS:
# - MTOW: ~600 kg (2 passengers + batteries)
# - Rotor Diameter: 5.2m per rotor
# - Arm Length: 1.4m from CG
# - Cruise Speed: 8 m/s (~29 km/h)
# - Flight Modes: Multicopter only (hover, position, mission)
#
# USAGE:
# 1. Place this file in: PX4-Autopilot/ROMFS/px4fmu_common/init.d-posix/airframes/
# 2. Run: make px4_sitl xplane_ehang184
# 3. Launch X-Plane with EHang 184 aircraft model
#
################################################################################

. ${R}etc/init.d/rc.mc_defaults


################################################################################
# CONTROL ALLOCATION - Motor Configuration
################################################################################
# Quadcopter X configuration with 5.2m diameter rotors
#
# Motor Layout:        Front
#                        ^
#                    1       0    (CW/CCW)
#                     \     /
#                      \   /
#                       \ /
#                       / \
#                      /   \
#                     /     \
#                    2       3
#
# Motor 0: Front-Right (CCW) - Position: (+1.4, -1.4, 0)m from CG
# Motor 1: Front-Left  (CW)  - Position: (+1.4, +1.4, 0)m from CG
# Motor 2: Rear-Left   (CCW) - Position: (-1.4, -1.4, 0)m from CG
# Motor 3: Rear-Right  (CW)  - Position: (-1.4, +1.4, 0)m from CG
#
# CT=6.5: Thrust coefficient tuned for large rotors
# KM=±0.05: Moment coefficient (sign determines rotation direction)

param set-default CA_AIRFRAME 0
param set-default CA_ROTOR_COUNT 4
param set-default CA_METHOD 2
param set-default CA_FAILURE_MODE 0

# Motor 0: Front-Right (CCW)
param set-default CA_ROTOR0_PX 1.4
param set-default CA_ROTOR0_PY -1.4
param set-default CA_ROTOR0_AZ -1
param set-default CA_ROTOR0_CT 6.5
param set-default CA_ROTOR0_KM -0.05

# Motor 1: Front-Left (CW)
param set-default CA_ROTOR1_PX 1.4
param set-default CA_ROTOR1_PY 1.4
param set-default CA_ROTOR1_AZ -1
param set-default CA_ROTOR1_CT 6.5
param set-default CA_ROTOR1_KM 0.05

# Motor 2: Rear-Left (CCW)
param set-default CA_ROTOR2_PX -1.4
param set-default CA_ROTOR2_PY -1.4
param set-default CA_ROTOR2_AZ -1
param set-default CA_ROTOR2_CT 6.5
param set-default CA_ROTOR2_KM 0.05

# Motor 3: Rear-Right (CW)
param set-default CA_ROTOR3_PX -1.4
param set-default CA_ROTOR3_PY 1.4
param set-default CA_ROTOR3_AZ -1
param set-default CA_ROTOR3_CT 6.5
param set-default CA_ROTOR3_KM -0.05

# PWM Output Mapping
param set-default PWM_MAIN_FUNC1 101
param set-default PWM_MAIN_FUNC2 102
param set-default PWM_MAIN_FUNC3 103
param set-default PWM_MAIN_FUNC4 104


################################################################################
# EKF2 SENSOR FUSION
################################################################################
# Optimized for X-Plane SITL with variable FPS (30-150 Hz)
#
# BAROMETER TUNING:
# - BARO_NOISE: 3.5mm (matches sensor implementation + safety margin)
#   * Actual sensor noise: 1mm gaussian
#   * 3.5x margin accounts for X-Plane physics + network jitter
#   * Result: Vertical velocity <0.3 m/s (was 0.5-1.5 m/s with default)
# - BARO_GATE: 8.0 (increased from default 3.0)
#   * Tolerates FPS-induced timing gaps and altitude transients
#   * Prevents false "BARO switch" errors during mission climbs
#
# GPS TUNING:
# - GPS_P_NOISE: 0.15m (matches vertical GPS accuracy)
#   * Prevents height drift by favoring barometer (±3.5mm) over GPS (±30cm)
# - Horizontal noise: 0.01m (GPS horizontal is more accurate)
#
# INNOVATION GATES:
# All gates increased to 5.0-8.0 (default 3.0) for FPS variability tolerance.
# Prevents false sensor faults during:
# - X-Plane FPS drops (timing jitter)
# - Mission altitude changes (pressure transients)
# - Waypoint transitions (acceleration spikes)
#
# TROUBLESHOOTING:
# If "BARO switch" errors occur:
# 1. Verify CAL_BARO1_PRIO=0 (backup sensor disabled)
# 2. Check only one barometer message per frame in px4xplane plugin
# 3. Increase EKF2_BARO_GATE if needed (max 10.0)

# Simulation mode enablement
param set-default SENS_EN_GPSSIM 1
param set-default SENS_EN_BAROSIM 1
param set-default SYS_HAS_BARO 1
param set-default SYS_HAS_GPS 1

# Barometer priority (single sensor for SITL simplicity)
param set-default CAL_BARO0_PRIO 100
param set-default CAL_BARO1_PRIO 0        # Backup disabled (prevents mid-mission switching)

# EKF2 core configuration
param set-default EKF2_BARO_CTRL 1
param set-default EKF2_MULTI_IMU 1

# Accelerometer bias estimation (v3.3.3 - X-Plane SITL optimized)
param set-default EKF2_ABIAS_INIT 0.2     # Tighter initial bias estimate
param set-default EKF2_ABL_LIM 2.5        # X-Plane SITL requires higher tolerance (see note below)
param set-default EKF2_ABL_TAU 0.5        # Slower bias adaptation (stability)
param set-default EKF2_ABL_ACCLIM 35.0
param set-default EKF2_ACC_NOISE 1.0      # Better accelerometer trust
param set-default EKF2_ACC_B_NOISE 0.001  # Accel bias noise - enables bias learning

# X-PLANE SITL NOTE: EKF2_ABL_LIM = 2.5 (vs Gazebo/jMAVSim default 0.4)
# Required because X-Plane has lower sensor rate (~100Hz vs 250Hz) and
# inherent physics engine variations that cause EKF2 to estimate higher bias.
# This does NOT affect flight performance - only the preflight arming check.

# Gyroscope Noise (v3.2.0 - added for bias estimation stability)
param set-default EKF2_GYR_NOISE 0.015    # Gyro measurement noise (rad/s)
param set-default EKF2_GYR_B_NOISE 0.001  # Gyro bias process noise (rad/s)

# Barometer parameters (v3.2.0 - CRITICAL)
param set-default EKF2_BARO_NOISE 0.003   # 3mm - matches plugin sensor noise
param set-default EKF2_BARO_DELAY 0.0
param set-default EKF2_BARO_GATE 10.0     # Increased for FPS variability tolerance

# GPS parameters
param set-default EKF2_GPS_DELAY 0.0
param set-default EKF2_GPS_P_NOISE 0.15   # Position noise (matches vertical accuracy)
param set-default EKF2_GPS_V_NOISE 0.15   # Realistic GPS velocity noise (was 0.01)
param set-default EKF2_GPS_P_GATE 5.0     # Innovation gate
param set-default EKF2_GPS_V_GATE 5.0

# Magnetometer parameters
param set-default EKF2_MAG_TYPE 0
param set-default EKF2_HEAD_NOISE 0.3
param set-default EKF2_MAG_NOISE 0.05
param set-default EKF2_MAG_GATE 5.0       # Increased for FPS tolerance

# Additional sensors
param set-default EKF2_AGP_CTRL 3
param set-default EKF2_ASP_DELAY 0.0
param set-default EKF2_AVEL_DELAY 0.0
param set-default EKF2_TAS_GATE 5.0
param set-default EKF2_WIND_NSD 0.01
param set-default EKF2_REQ_VDRIFT 1.0

# IMU configuration
param set-default IMU_GYRO_RATEMAX 100
param set-default IMU_INTEG_RATE 100


################################################################################
# MULTICOPTER RATE CONTROL (Inner Loop PID)
################################################################################
# Attitude rate controllers for roll, pitch, yaw.
#
# TUNING GUIDE:
# - P gain: Responsiveness (higher = faster, can cause oscillation)
# - I gain: Steady-state error correction (too high = overshoot)
# - D gain: Damping (reduces oscillation, sensitive to noise)
# - FF: Feedforward (improves tracking, reduces lag)
# - K: Loop gain multiplier
#
# For new airframes:
# 1. Start with these conservative values
# 2. Increase P until slight oscillation, then back off 20-30%
# 3. Add D for damping (typically P/10)
# 4. Add I last (typically P/15)

# Roll rate (tuned for large rotors)
param set-default MC_ROLLRATE_P 0.15
param set-default MC_ROLLRATE_I 0.1        # Conservative - high I can worsen oscillation
param set-default MC_ROLLRATE_D 0.01
param set-default MC_ROLLRATE_FF 0
param set-default MC_ROLLRATE_K 2.25
param set-default MC_ROLLRATE_MAX 220
param set-default MC_RR_INT_LIM 0.3

# Pitch rate (tuned for large rotors)
param set-default MC_PITCHRATE_P 0.15
param set-default MC_PITCHRATE_I 0.1       # Conservative - high I can worsen oscillation
param set-default MC_PITCHRATE_D 0.01
param set-default MC_PITCHRATE_FF 0
param set-default MC_PITCHRATE_K 3
param set-default MC_PITCHRATE_MAX 220
param set-default MC_PR_INT_LIM 0.3

# Yaw rate
param set-default MC_YAWRATE_P 2
param set-default MC_YAWRATE_I 0.1         # Enabled for steady-state yaw correction
param set-default MC_YAWRATE_D 0.01        # Added damping to prevent overshoot
param set-default MC_YAWRATE_FF 0.1        # Reduced feedforward (was 0.2)
param set-default MC_YAWRATE_K 0.6
param set-default MC_YAWRATE_MAX 100
param set-default MC_YR_INT_LIM 0.3


################################################################################
# MULTICOPTER ATTITUDE CONTROL (Outer Loop)
################################################################################
# Attitude controllers - conservative gains for large 5.2m rotors
# NOTE: K factors (2.25-3.0) already provide gain boost in rate loop
# Keep attitude P-gains low to prevent commanding unreachable rates

param set-default MC_ROLL_P 0.6            # Conservative (K=2.25 compensates)
param set-default MC_PITCH_P 0.6           # Conservative (K=3.0 compensates)
param set-default MC_YAW_P 0.6             # Original value (K=0.6 - no gain boost)
param set-default MC_YAW_WEIGHT 0.4        # Prioritizes roll/pitch over yaw


################################################################################
# POSITION & VELOCITY CONTROL
################################################################################
# Tuned for 600kg passenger aircraft with comfort priority

# Position control
param set-default MPC_XY_P 0.3            # Smooth position tracking
param set-default MPC_Z_P 0.8             # Responsive altitude hold

# Velocity control
param set-default MPC_XY_VEL_P_ACC 1.5    # Better velocity tracking
param set-default MPC_XY_VEL_I_ACC 0.4    # Wind rejection
param set-default MPC_XY_VEL_D_ACC 0.5    # Noise-filtered derivative
param set-default MPC_Z_VEL_P_ACC 4.0     # Responsive vertical control
param set-default MPC_Z_VEL_I_ACC 2.0
param set-default MPC_Z_VEL_D_ACC 0.2

# Velocity limits (passenger comfort priority)
param set-default MPC_XY_VEL_MAX 12       # Max horizontal (m/s) ~43 km/h
param set-default MPC_Z_VEL_MAX_UP 3      # Max ascent (m/s) - smooth climb
param set-default MPC_Z_VEL_MAX_DN 1.5    # Max descent (m/s) - gentle
param set-default MPC_VEL_MANUAL 10
param set-default MPC_XY_CRUISE 8         # Cruise speed ~29 km/h (passenger comfort)

# Trajectory & jerk limits (reduced for smooth ride)
param set-default MPC_XY_TRAJ_P 0.5
param set-default MPC_JERK_AUTO 0.8       # Auto jerk limit (reduced for comfort)
param set-default MPC_JERK_MAX 2.5        # Max jerk (reduced for comfort)

# Error limits
param set-default MPC_XY_ERR_MAX 2


################################################################################
# MANUAL FLIGHT MODE
################################################################################
# Manual flight characteristics and feel.

# Tilt & attitude limits
param set-default MPC_MAN_TILT_MAX 35
param set-default MPC_TILTMAX_AIR 45
param set-default MPC_TILTMAX_LND 12

# Throttle settings
param set-default MPC_THR_HOVER 0.5
param set-default MPC_THR_MIN 0.12
param set-default MPC_THR_MAX 1
param set-default MPC_MANTHR_MIN 0.08
param set-default MPC_THR_CURVE 0
param set-default MPC_THR_XY_MARG 0.3

# Yaw control
param set-default MPC_MAN_Y_MAX 20
param set-default MPC_MAN_Y_TAU 0.2        # Slower yaw response (was 0.08) - prevents overshoot
param set-default MPC_YAWRAUTO_ACC 20
param set-default MPC_YAWRAUTO_MAX 30

# Position hold
param set-default MPC_HOLD_MAX_XY 0.8
param set-default MPC_HOLD_MAX_Z 0.6

# Advanced options
param set-default MPC_POS_MODE 4
param set-default MPC_ALT_MODE 0
param set-default MPC_USE_HTE 1
param set-default MPC_VELD_LP 5
param set-default MPC_VEL_MAN_BACK -1
param set-default MPC_VEL_MAN_SIDE -1
param set-default MPC_XY_VEL_ALL -10


################################################################################
# TAKEOFF & LANDING
################################################################################

# Takeoff
param set-default MPC_TKO_SPEED 1.5       # Climb rate (m/s)
param set-default MPC_TKO_RAMP_T 3        # Ramp time (s)

# Landing
param set-default MPC_LAND_ALT1 10        # Phase 1 altitude (m)
param set-default MPC_LAND_ALT2 5         # Phase 2 altitude (m)
param set-default MPC_LAND_ALT3 1         # Phase 3 altitude (m)
param set-default MPC_LAND_CRWL 0.3       # Crawl speed (m/s)
param set-default MPC_LAND_RADIUS 1000
param set-default MPC_LAND_RC_HELP 1

# Land detector
param set-default LNDMC_ALT_GND 2
param set-default LNDMC_XY_VEL_MAX 1.5
param set-default LNDMC_Z_VEL_MAX 0.25
param set-default LNDMC_ROT_MAX 20
param set-default LNDMC_TRIG_TIME 1


################################################################################
# ACRO MODE
################################################################################
# Aerobatic mode for experienced pilots.

param set-default MC_ACRO_P_MAX 100
param set-default MC_ACRO_R_MAX 100
param set-default MC_ACRO_Y_MAX 100
param set-default MC_ACRO_EXPO 0
param set-default MC_ACRO_EXPO_Y 0
param set-default MC_ACRO_SUPEXPO 0
param set-default MC_ACRO_SUPEXPOY 0


################################################################################
# AUTO-TUNING
################################################################################

param set-default MC_AT_APPLY 1
param set-default MC_AT_RISE_TIME 0.14
param set-default MC_AT_START 0
param set-default MC_AT_SYSID_AMP 0.7


################################################################################
# NAVIGATION & MISSION
################################################################################
# LARGE MANNED AIRCRAFT CONFIGURATION
#
# Design philosophy: This is a passenger-carrying airtaxi (~600kg MTOW),
# not a small racing drone. Parameters prioritize passenger comfort, safety
# margins, and operational efficiency over pinpoint accuracy.
#
# TUNING BY AIRCRAFT SIZE:
# - Small drone (<2kg):       NAV_ACC_RAD=5m,  ALT_RAD=0.8m, JERK=2.0
# - Medium drone (2-25kg):    NAV_ACC_RAD=10m, ALT_RAD=1.5m, JERK=1.5
# - Large airtaxi (>100kg):   NAV_ACC_RAD=35m, ALT_RAD=3m, JERK=0.8  ← Current
# - Heavy cargo (>500kg):     NAV_ACC_RAD=50m, ALT_RAD=5m, JERK=0.5

# Mission parameters
param set-default MIS_YAW_ERR 30          # Max yaw error (deg) - gentle corrections
param set-default MIS_YAW_TMT 5
param set-default MIS_TAKEOFF_ALT 2.5     # Default takeoff alt (m)

# Navigation acceptance radii (CRITICAL FOR LARGE AIRCRAFT)
# Larger radii = smoother flight, less hovering at waypoints
# 35m radius provides smooth urban flight comfortable for passengers
param set-default NAV_ACC_RAD 35          # Horizontal acceptance radius (m)
param set-default NAV_MC_ALT_RAD 3        # Vertical acceptance radius (m)

# Return to launch
param set-default RTL_RETURN_ALT 30       # RTL altitude (m)
param set-default RTL_DESCEND_ALT 30
param set-default RTL_LAND_DELAY 0


################################################################################
# ADVANCED FEATURES
################################################################################

# Collision prevention
param set-default CP_DELAY 0.4
param set-default CP_DIST -1              # Disabled
param set-default CP_GO_NO_DATA 0
param set-default CP_GUIDE_ANG 30

# Follow target
param set-default FLW_TGT_ALT_M 0
param set-default FLW_TGT_DST 8
param set-default FLW_TGT_FA 180
param set-default FLW_TGT_HT 8
param set-default FLW_TGT_MAX_VEL 5
param set-default FLW_TGT_RS 0.1

# Hover thrust estimator
param set-default HTE_ACC_GATE 3
param set-default HTE_HT_ERR_INIT 0.1
param set-default HTE_HT_NOISE 0.0036
param set-default HTE_THR_RANGE 0.2
param set-default HTE_VXY_THR 10
param set-default HTE_VZ_THR 2

# GPS configuration
param set-default GPS_UBX_DYNMODEL 6      # Airborne <1g

# Orbit mode
param set-default MC_ORBIT_RAD_MAX 1000

# System response
param set-default SYS_VEHICLE_RESP -0.4   # Smooth (-1=very smooth, 0=responsive)

# Battery compensation
param set-default MC_BAT_SCALE_EN 0


################################################################################
# TROUBLESHOOTING GUIDE
################################################################################
#
# ATTITUDE OSCILLATION (pitch/roll):
#   - CRITICAL: This aircraft has 5.2m rotors with high inertia
#   - K factors (2.25-3.0) already provide gain boost in rate loop
#   - If oscillation: REDUCE MC_ROLL_P, MC_PITCH_P (current: 0.6)
#   - Do NOT increase attitude P-gains above 1.0 for this airframe
#
# EKF2 ERRORS:
#   "High accelerometer bias":
#     - Verify IMU_INTEG_RATE = 100 (matches plugin sensor rate)
#     - Check EKF2_ABIAS_INIT = 0.2, EKF2_ACC_B_NOISE = 0.001
#   "Height estimate not stable":
#     - Verify EKF2_BARO_NOISE = 0.003 (matches plugin noise)
#     - Check EKF2_GPS_V_NOISE = 0.15
#
# Position drift in hover:
#   - Verify MPC_XY_P = 0.3
#   - Check MPC_XY_VEL_I_ACC = 0.4 for wind rejection
#
# Sluggish attitude response:
#   - Verify MC_ROLL_P = 0.6, MC_PITCH_P = 0.6 (conservative for large rotors)
#   - Note: K factors already provide 2-3x gain boost
#
# Yaw drift:
#   - Verify MC_YAWRATE_I = 0.1 (must be non-zero)
#   - Check MC_YAW_P = 0.6
#
# Altitude oscillation:
#   - Verify MPC_Z_P = 0.8
#   - Check MPC_Z_VEL_P_ACC = 4.0
#
# VALIDATED SETTINGS (December 2025):
# - MC_ROLLRATE_I = 0.1, MC_PITCHRATE_I = 0.1, MC_YAWRATE_I = 0.1
# - MC_ROLL_P = 0.6, MC_PITCH_P = 0.6, MC_YAW_P = 0.6
# - MPC_XY_P = 0.3, MPC_Z_P = 0.8
#
################################################################################
# END OF CONFIGURATION
################################################################################
# Maintainer: px4xplane project - https://github.com/alireza787b/px4xplane/
# Status: Production-ready for X-Plane SITL simulation
# Flight Modes: MC (hover, position, mission)
################################################################################
